class JIAModern{constructor(){this.socket=null,this.sessionId=this.generateSessionId(),this.isListening=!1,this.recognition=null,this.synthesis=null,this.voiceEnabled=!0,this.settings=null,this.currentTheme=this.detectSystemTheme(),this.isTyping=!1,this.messages=[],this.toasts=[],this.ui={loading:!0,welcomeVisible:!0,settingsOpen:!1,voiceModalOpen:!1,darkMode:"dark"===this.currentTheme},this.initialize()}async initialize(){console.log("ðŸš€ Initializing JIA Modern Interface...");try{this.initializeTheme(),this.initializeParticles(),this.initializeElements(),this.initializeSocket(),this.initializeVoiceFeatures(),this.initializeModernFeatures(),this.bindEvents(),this.loadSettings(),this.configureMarkdown(),await this.handleLoadingSequence(),console.log("âœ… JIA Modern Interface initialized successfully")}catch(e){console.error("âŒ Failed to initialize JIA:",e),this.showToast("Failed to initialize application","error")}}initializeTheme(){document.documentElement.setAttribute("data-theme",this.ui.darkMode?"dark":"light"),this.updateThemeToggle(),window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",(e=>{localStorage.getItem("jia-theme")||this.setTheme(e.matches?"dark":"light")}))}setTheme(e){this.ui.darkMode="dark"===e,document.documentElement.setAttribute("data-theme",e),localStorage.setItem("jia-theme",e),this.updateThemeToggle(),this.particles&&this.updateParticleTheme(e),this.showToast(`Switched to ${e} theme`,"success")}updateThemeToggle(){const e=document.querySelector(".theme-toggle");e&&e.classList.toggle("dark",this.ui.darkMode)}detectSystemTheme(){return localStorage.getItem("jia-theme")?localStorage.getItem("jia-theme"):window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light"}initializeParticles(){if("undefined"==typeof particlesJS)return void console.warn("âš ï¸ Particles.js not loaded");const e={particles:{number:{value:50,density:{enable:!0,value_area:800}},color:{value:this.ui.darkMode?"#3b82f6":"#2563eb"},shape:{type:"circle"},opacity:{value:.3,random:!0,anim:{enable:!0,speed:1,opacity_min:.1}},size:{value:3,random:!0,anim:{enable:!0,speed:2,size_min:.1}},line_linked:{enable:!0,distance:150,color:this.ui.darkMode?"#60a5fa":"#3b82f6",opacity:.2,width:1},move:{enable:!0,speed:2,direction:"none",random:!1,straight:!1,out_mode:"out",bounce:!1}},interactivity:{detect_on:"canvas",events:{onhover:{enable:!0,mode:"repulse"},onclick:{enable:!0,mode:"push"},resize:!0}},retina_detect:!0};particlesJS("particle-background",e)}updateParticleTheme(e){if(window.pJSDom&&window.pJSDom[0]&&window.pJSDom[0].pJS){const t=window.pJSDom[0].pJS;t.particles.color.value="dark"===e?"#60a5fa":"#3b82f6",t.particles.line_linked.color="dark"===e?"#60a5fa":"#3b82f6",t.fn.canvasInit(),t.fn.canvasDraw()}}async handleLoadingSequence(){const e=document.getElementById("loading-screen"),t=document.getElementById("app-container");e&&t&&(await this.delay(2e3),e.classList.add("hidden"),await this.delay(500),t.style.opacity="1",t.style.transform="translateY(0)",setTimeout((()=>{e.style.display="none",this.ui.loading=!1,setTimeout((()=>this.initializeParticles()),1e3)}),800))}delay(e){return new Promise((t=>setTimeout(t,e)))}initializeElements(){this.elements={appContainer:document.getElementById("app-container"),chatMessages:document.getElementById("chat-messages"),messagesContainer:document.getElementById("messages-container"),messageInput:document.getElementById("message-input"),sendButton:document.getElementById("send-button"),themeToggle:document.getElementById("theme-toggle"),voiceToggle:document.getElementById("voice-toggle"),clearChat:document.getElementById("clear-chat"),settingsToggle:document.getElementById("settings-toggle"),settingsClose:document.getElementById("settings-close"),settingsPanel:document.getElementById("settings-panel"),voiceModal:document.getElementById("voice-modal"),voiceCancel:document.getElementById("voice-cancel"),voiceTranscript:document.getElementById("voice-transcript"),welcomeScreen:document.getElementById("welcome-screen"),typingIndicator:document.getElementById("typing-indicator"),quickSuggestions:document.getElementById("quick-suggestions"),toastContainer:document.getElementById("toast-container"),scrollToBottom:document.getElementById("scroll-to-bottom"),newChatFab:document.getElementById("new-chat-fab"),attachButton:document.getElementById("attach-button"),emojiButton:document.getElementById("emoji-button"),charCount:document.getElementById("char-count"),voiceEnabled:document.getElementById("voice-enabled"),testVoice:document.getElementById("test-voice"),stopVoice:document.getElementById("stop-voice"),soundEffects:document.getElementById("sound-effects")},this.elements.appContainer&&(this.elements.appContainer.style.opacity="0",this.elements.appContainer.style.transform="translateY(20px)",this.elements.appContainer.style.transition="all 0.8s cubic-bezier(0.4, 0, 0.2, 1)")}initializeModernFeatures(){this.initializeToastSystem(),this.initializeScrollFeatures(),this.initializeInputEnhancements(),this.initializeAccessibility()}initializeToastSystem(){this.elements.toastContainer||(this.elements.toastContainer=document.createElement("div"),this.elements.toastContainer.id="toast-container",this.elements.toastContainer.className="toast-container",document.body.appendChild(this.elements.toastContainer))}showToast(e,t="info",s=5e3){const i=document.createElement("div");i.className=`toast ${t}`;const n=this.getToastIcon(t);return i.innerHTML=`\n            <div class="toast-content">\n                <i class="toast-icon fas fa-${n}"></i>\n                <div class="toast-message">${e}</div>\n                <button class="toast-close">\n                    <i class="fas fa-times"></i>\n                </button>\n            </div>\n        `,this.elements.toastContainer.appendChild(i),setTimeout((()=>this.removeToast(i)),s),i.querySelector(".toast-close").addEventListener("click",(()=>{this.removeToast(i)})),i}getToastIcon(e){return{success:"check-circle",error:"exclamation-circle",warning:"exclamation-triangle",info:"info-circle"}[e]||"info-circle"}removeToast(e){e.style.opacity="0",e.style.transform="translateX(100%)",setTimeout((()=>{e.parentNode&&e.parentNode.removeChild(e)}),300)}initializeScrollFeatures(){const e=this.elements.messagesContainer,t=this.elements.scrollToBottom;e&&e.addEventListener("scroll",(()=>{const{scrollTop:s,scrollHeight:i,clientHeight:n}=e,o=s+n>=i-100;t&&t.classList.toggle("hidden",o)}))}initializeInputEnhancements(){const e=this.elements.messageInput,t=this.elements.charCount;e&&t&&(e.addEventListener("input",(()=>{const s=e.value.length;t.textContent=s,t.className="char-counter",s>1800&&t.classList.add("warning"),s>=2e3&&t.classList.add("error"),this.autoResizeTextarea(e),this.updateSendButton()})),e.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})))}autoResizeTextarea(e){e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"}initializeAccessibility(){document.addEventListener("keydown",(e=>{"Escape"===e.key&&this.closeAllModals()})),this.trapFocus(this.elements.settingsPanel)}trapFocus(e){e&&e.addEventListener("keydown",(t=>{if("Tab"!==t.key)return;const s=e.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'),i=s[0],n=s[s.length-1];t.shiftKey?document.activeElement===i&&(t.preventDefault(),n.focus()):document.activeElement===n&&(t.preventDefault(),i.focus())}))}initializeVoiceFeatures(){if(!("webkitSpeechRecognition"in window)&&!("SpeechRecognition"in window))return console.warn("Speech recognition not supported"),void this.elements?.voiceToggle?.classList.add("hidden");const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new e,this.recognition.continuous=!1,this.recognition.interimResults=!0,this.recognition.lang="en-US",this.recognition.onstart=()=>{this.isListening=!0,this.showVoiceModal(),this.updateVoiceUI()},this.recognition.onresult=e=>{let t="";for(let s=e.resultIndex;s<e.results.length;s++)t+=e.results[s][0].transcript;this.updateVoiceTranscript(t)},this.recognition.onerror=e=>{console.error("Speech recognition error:",e.error),this.showToast(`Voice recognition error: ${e.error}`,"error"),this.hideVoiceModal()},this.recognition.onend=()=>{this.isListening=!1,this.hideVoiceModal(),this.updateVoiceUI()}}showVoiceModal(){this.elements.voiceModal&&(this.elements.voiceModal.classList.add("active"),this.ui.voiceModalOpen=!0,setTimeout((()=>{this.elements.voiceModal.querySelector(".voice-content").style.transform="scale(1)"}),10))}hideVoiceModal(){this.elements.voiceModal&&(this.elements.voiceModal.classList.remove("active"),this.ui.voiceModalOpen=!1,setTimeout((()=>{this.updateVoiceTranscript("")}),300))}updateVoiceTranscript(e){this.elements.voiceTranscript&&(this.elements.voiceTranscript.textContent=e||"Listening...")}updateVoiceUI(){const e=this.elements.voiceToggle;e&&e.classList.toggle("listening",this.isListening)}initializeSocket(){console.log("Initializing Socket.IO connection...");let e=!1;try{const t=window.location.hostname,s=new URLSearchParams(window.location.search);e="1"===s.get("useSocket")||"localhost"===t||"127.0.0.1"===t}catch(t){e=!0}e?(this.socket=io({transports:["websocket","polling"],upgrade:!0}),this.socket.on("connect",(()=>{console.log("âœ… Connected to JIA server"),this.socket.emit("join",{sessionId:this.sessionId})})),this.socket.on("disconnect",(()=>{console.log("âš ï¸ Disconnected from server"),this.showToast("Connection lost","warning")})),this.socket.on("alfred-message",(e=>{this.handleReceivedMessage(e.message)})),this.socket.on("error",(e=>{console.error("Socket error:",e),this.showToast("Connection error","error")}))):console.log("Using HTTP API mode")}async handleReceivedMessage(e){this.hideTyping(),this.ui.welcomeVisible&&this.hideWelcomeScreen();const t=this.createMessageElement(e,"alfred");this.elements.chatMessages.appendChild(t),this.scrollToBottom(),this.voiceEnabled&&this.elements.soundEffects?.checked&&this.speakMessage(e)}createMessageElement(e,t){const s=document.createElement("div");s.className=`message ${t}-message`;const i=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"}),n="alfred"===t?'<div class="avatar-container mini"><div class="avatar-core"><i class="fas fa-robot"></i></div></div>':'<div class="avatar-container mini"><div class="avatar-core"><i class="fas fa-user"></i></div></div>';s.innerHTML=`\n            <div class="message-avatar">\n                ${n}\n            </div>\n            <div class="message-content">\n                <div class="message-bubble">\n                    ${this.formatMessageContent(e)}\n                </div>\n                <div class="message-footer">\n                    <div class="message-time">${i}</div>\n                    <div class="message-actions">\n                        <button class="message-action" title="Copy">\n                            <i class="fas fa-copy"></i>\n                        </button>\n                        <button class="message-action" title="Speak">\n                            <i class="fas fa-volume-up"></i>\n                        </button>\n                    </div>\n                </div>\n            </div>\n        `;const o=s.querySelector('[title="Copy"]'),a=s.querySelector('[title="Speak"]');return o.addEventListener("click",(()=>{navigator.clipboard.writeText(e),this.showToast("Message copied to clipboard","success")})),a.addEventListener("click",(()=>{this.speakMessage(e)})),setTimeout((()=>{s.querySelectorAll("pre code").forEach((e=>{hljs.highlightElement(e)}))}),100),s}formatMessageContent(e){const t=marked.parse(e);return DOMPurify.sanitize(t)}async sendMessage(){const e=this.elements.messageInput,t=e.value.trim();if(!t)return;this.ui.welcomeVisible&&this.hideWelcomeScreen();const s=this.createMessageElement(t,"user");this.elements.chatMessages.appendChild(s),e.value="",this.autoResizeTextarea(e),this.updateSendButton(),this.updateCharCount(),this.scrollToBottom(),this.showTyping();try{if(this.socket)this.socket.emit("message",{sessionId:this.sessionId,message:t});else{const e=await fetch("/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:t,sessionId:this.sessionId})}),s=await e.json();this.handleReceivedMessage(s.response||s.error||"No response received")}}catch(e){console.error("Error sending message:",e),this.showToast("Failed to send message","error"),this.hideTyping()}}showTyping(){this.elements.typingIndicator&&(this.elements.typingIndicator.classList.add("active"),this.isTyping=!0)}hideTyping(){this.elements.typingIndicator&&(this.elements.typingIndicator.classList.remove("active"),this.isTyping=!1)}scrollToBottom(){this.elements.messagesContainer&&(this.elements.messagesContainer.scrollTop=this.elements.messagesContainer.scrollHeight)}hideWelcomeScreen(){this.elements.welcomeScreen&&(this.elements.welcomeScreen.classList.add("hidden"),this.ui.welcomeVisible=!1)}bindEvents(){this.elements.themeToggle?.addEventListener("click",(()=>{this.setTheme(this.ui.darkMode?"light":"dark")})),this.elements.voiceToggle?.addEventListener("click",(()=>{this.recognition&&(this.isListening?this.recognition.stop():this.recognition.start())})),this.elements.settingsToggle?.addEventListener("click",(()=>{this.toggleSettings()})),this.elements.settingsClose?.addEventListener("click",(()=>{this.closeSettings()})),this.elements.sendButton?.addEventListener("click",(()=>{this.sendMessage()})),this.elements.clearChat?.addEventListener("click",(()=>{this.clearChat()})),this.elements.voiceCancel?.addEventListener("click",(()=>{this.recognition&&this.recognition.stop()})),this.elements.scrollToBottom?.addEventListener("click",(()=>{this.scrollToBottom()})),this.elements.newChatFab?.addEventListener("click",(()=>{this.startNewChat()})),document.querySelectorAll(".quick-action, .suggestion-chip").forEach((e=>{e.addEventListener("click",(e=>{const t=e.currentTarget.getAttribute("data-suggestion");t&&(this.elements.messageInput.value=t,this.updateSendButton(),this.sendMessage())}))})),this.elements.voiceEnabled?.addEventListener("change",(e=>{this.voiceEnabled=e.target.checked,localStorage.setItem("jia-voice-enabled",this.voiceEnabled)})),this.elements.testVoice?.addEventListener("click",(()=>{this.testVoice()})),this.elements.stopVoice?.addEventListener("click",(()=>{this.stopVoice()})),this.elements.soundEffects?.addEventListener("change",(e=>{localStorage.setItem("jia-sound-effects",e.target.checked)}))}toggleSettings(){this.elements.settingsPanel&&(this.elements.settingsPanel.classList.toggle("active"),this.ui.settingsOpen=this.elements.settingsPanel.classList.contains("active"))}closeSettings(){this.elements.settingsPanel&&(this.elements.settingsPanel.classList.remove("active"),this.ui.settingsOpen=!1)}updateSendButton(){const e=this.elements.messageInput,t=this.elements.sendButton;if(e&&t){const s=e.value.trim().length>0;t.disabled=!s}}updateCharCount(){const e=this.elements.messageInput,t=this.elements.charCount;if(e&&t){const s=e.value.length;t.textContent=s}}clearChat(){this.elements.chatMessages&&(this.elements.chatMessages.innerHTML="",this.ui.welcomeVisible=!0,this.showWelcomeScreen(),this.showToast("Chat cleared","success"))}showWelcomeScreen(){this.elements.welcomeScreen&&(this.elements.welcomeScreen.classList.remove("hidden"),this.ui.welcomeVisible=!0)}startNewChat(){this.clearChat(),this.messages=[],this.sessionId=this.generateSessionId(),this.showToast("Started new chat","info")}testVoice(){if(this.synthesis){const e=new SpeechSynthesisUtterance("Hello! This is a test of JIA's voice capabilities.");e.rate=.9,e.pitch=1.1,this.synthesis.speak(e),this.showToast("Voice test played","success")}else this.showToast("Voice synthesis not available","warning")}stopVoice(){this.synthesis&&(this.synthesis.cancel(),this.showToast("Voice stopped","info"))}speakMessage(e){if(!this.synthesis)return;const t=new SpeechSynthesisUtterance(e);t.rate=.9,t.pitch=1,t.volume=.8,this.synthesis.speak(t)}generateSessionId(){return Date.now().toString(36)+Math.random().toString(36).substr(2)}closeAllModals(){this.closeSettings(),this.hideVoiceModal()}loadSettings(){this.voiceEnabled="false"!==localStorage.getItem("jia-voice-enabled");const e="false"!==localStorage.getItem("jia-sound-effects");this.elements.voiceEnabled&&(this.elements.voiceEnabled.checked=this.voiceEnabled),this.elements.soundEffects&&(this.elements.soundEffects.checked=e)}configureMarkdown(){marked.setOptions({highlight:(e,t)=>{if(t&&hljs.getLanguage(t))try{return hljs.highlight(e,{language:t}).value}catch(e){}return hljs.highlightAuto(e).value},langPrefix:"hljs language-",breaks:!0,gfm:!0})}handleError(e,t="Unknown"){console.error(`Error in ${t}:`,e),this.showToast(`${t}: ${e.message}`,"error")}}document.addEventListener("DOMContentLoaded",(()=>{window.jia=new JIAModern})),document.addEventListener("visibilitychange",(()=>{document.hidden?document.body.classList.add("page-hidden"):document.body.classList.remove("page-hidden")})),window.addEventListener("online",(()=>{window.jia&&window.jia.showToast("Connection restored","success")})),window.addEventListener("offline",(()=>{window.jia&&window.jia.showToast("You are offline","warning")})),"serviceWorker"in navigator&&window.addEventListener("load",(()=>{navigator.serviceWorker.register("/sw.js").then((e=>{console.log("SW registered: ",e)})).catch((e=>{console.log("SW registration failed: ",e)}))}));