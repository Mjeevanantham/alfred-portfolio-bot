class JIAChat{constructor(){this.socket=null,this.sessionId=this.generateSessionId(),this.isListening=!1,this.recognition=null,this.synthesis=null,this.voiceEnabled=!0,this.settings=null,this.initializeElements(),this.initializeSocket(),this.initializeVoiceFeatures(),this.bindEvents(),this.initializeUI(),this.loadSettings(),this.configureMarkdown()}initializeElements(){this.elements={chatMessages:document.getElementById("chatMessages"),messageInput:document.getElementById("messageInput"),sendButton:document.getElementById("sendButton"),typingIndicator:document.getElementById("typingIndicator"),voiceToggle:document.getElementById("voiceToggle"),clearChat:document.getElementById("clearChat"),settingsPanel:document.getElementById("settingsPanel"),settingsToggle:document.getElementById("settingsToggle"),voiceModal:document.getElementById("voiceModal"),stopListening:document.getElementById("stopListening"),inputSuggestions:document.getElementById("inputSuggestions"),voiceEnabled:document.getElementById("voiceEnabled"),stopVoice:document.getElementById("stopVoice")}}initializeSocket(){console.log("Initializing Socket.IO connection..."),this.socket=io(),this.socket.on("connect",(()=>{console.log("‚úÖ Connected to JIA server:",this.socket.id)})),this.socket.on("connect_error",(e=>{console.error("‚ùå Socket.IO connection error:",e),this.showNotification("Failed to connect to server","error")})),this.socket.on("disconnect",(e=>{console.log("‚ö†Ô∏è Disconnected from JIA server:",e)})),this.socket.on("alfred-response",(e=>{console.log("üì® Received JIA response:",e),this.hideTypingIndicator(),this.addMessage(e.message,"alfred"),this.voiceEnabled&&this.synthesis&&this.speakMessage(e.message)})),this.socket.on("alfred-error",(e=>{console.error("‚ùå JIA error:",e),this.hideTypingIndicator(),this.addMessage(e.message,"alfred")}))}initializeVoiceFeatures(){if("webkitSpeechRecognition"in window||"SpeechRecognition"in window){const e=window.SpeechRecognition||window.webkitSpeechRecognition;this.recognition=new e,this.recognition.continuous=!1,this.recognition.interimResults=!1,this.recognition.lang="en-US",this.recognition.onresult=e=>{const t=e.results[0][0].transcript;this.elements.messageInput.value=t,this.stopVoiceInput(),this.sendMessage()},this.recognition.onerror=e=>{console.error("Speech recognition error:",e.error),this.stopVoiceInput(),this.showNotification("Voice recognition failed. Please try again.","error")},this.recognition.onend=()=>{this.stopVoiceInput()}}"speechSynthesis"in window&&(this.synthesis=window.speechSynthesis)}bindEvents(){this.elements.sendButton.addEventListener("click",(()=>this.sendMessage())),this.elements.messageInput.addEventListener("keydown",(e=>{"Enter"!==e.key||e.shiftKey||(e.preventDefault(),this.sendMessage())})),this.elements.messageInput.addEventListener("input",(()=>{this.autoResizeTextarea()})),this.elements.voiceToggle.addEventListener("click",(()=>this.toggleVoiceInput())),this.elements.stopListening.addEventListener("click",(()=>this.stopVoiceInput())),this.elements.stopVoice.addEventListener("click",(()=>this.stopAllVoice())),this.elements.settingsToggle&&this.elements.settingsToggle.addEventListener("click",(e=>{e.stopPropagation(),this.elements.settingsPanel.classList.toggle("active")})),this.elements.clearChat.addEventListener("click",(()=>this.clearChat())),this.elements.voiceEnabled.addEventListener("change",(()=>this.toggleVoiceSettings())),this.elements.inputSuggestions.addEventListener("click",(e=>{if(e.target.classList.contains("suggestion-chip")){const t=e.target.getAttribute("data-suggestion");this.elements.messageInput.value=t,this.sendMessage()}})),document.addEventListener("click",(e=>{const t=this.elements.settingsPanel,s=this.elements.settingsToggle;t&&!t.contains(e.target)&&s&&!s.contains(e.target)&&t.classList.remove("active")}))}initializeUI(){this.elements.messageInput.focus(),this.updateVoiceToggleVisibility()}async loadSettings(){try{const e=await fetch("/api/admin/settings");e.ok&&(this.settings=await e.json(),this.voiceEnabled=this.settings.voiceEnabled,this.elements.voiceEnabled.checked=this.voiceEnabled,this.updateVoiceToggleVisibility())}catch(e){console.error("Error loading settings:",e)}}updateVoiceToggleVisibility(){this.voiceEnabled?this.elements.voiceToggle.style.display="flex":this.elements.voiceToggle.style.display="none"}toggleVoiceSettings(){this.voiceEnabled=this.elements.voiceEnabled.checked,this.updateVoiceToggleVisibility(),this.voiceEnabled||this.stopAllVoice()}stopAllVoice(){this.synthesis&&this.synthesis.cancel(),this.recognition&&this.isListening&&this.recognition.stop(),this.isListening=!1,this.elements.voiceModal.classList.remove("active"),this.elements.voiceToggle.innerHTML='<i class="fas fa-microphone"></i>',this.showNotification("Voice features stopped","info")}generateSessionId(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}sendMessage(){const e=this.elements.messageInput.value.trim();e&&(console.log("üì§ Sending message:",e),this.addMessage(e,"user"),this.elements.messageInput.value="",this.autoResizeTextarea(),this.showTypingIndicator(),this.socket&&this.socket.connected?(console.log("üì° Sending via Socket.IO..."),this.socket.emit("chat-message",{message:e,sessionId:this.sessionId})):(console.error("‚ùå Socket not connected, falling back to fetch..."),this.sendViaFetch(e)),this.elements.inputSuggestions.style.display="none")}async sendViaFetch(e){try{const t=await fetch("/api/chat/message",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({message:e,sessionId:this.sessionId})});if(!t.ok)throw new Error("Failed to send message");{const e=await t.json();this.hideTypingIndicator(),this.addMessage(e.content,"alfred")}}catch(e){console.error("‚ùå Fetch error:",e),this.hideTypingIndicator(),this.addMessage("Sorry, I encountered an error. Please try again.","alfred")}}addMessage(e,t){const s=document.createElement("div");s.className=`message ${t}-message`;const i=(new Date).toLocaleTimeString([],{hour:"2-digit",minute:"2-digit"});s.innerHTML="alfred"===t?`\n                <div class="message-avatar">\n                    <div class="avatar-circle">\n                        <i class="fas fa-robot"></i>\n                    </div>\n                </div>\n                <div class="message-content">\n                    <div class="message-bubble">\n                        <div class="markdown-body">${this.formatMessage(e)}</div>\n                    </div>\n                    <div class="message-time">${i}</div>\n                </div>\n            `:`\n                <div class="message-avatar">\n                    <div class="avatar-circle">\n                        <i class="fas fa-user"></i>\n                    </div>\n                </div>\n                <div class="message-content">\n                    <div class="message-bubble">\n                        <div class="markdown-body">${this.formatMessage(e)}</div>\n                    </div>\n                    <div class="message-time">${i}</div>\n                </div>\n            `,this.elements.chatMessages.appendChild(s);try{if(window.hljs){s.querySelectorAll("pre code").forEach((e=>{window.hljs.highlightElement(e)}))}}catch(e){console.warn("Highlighting failed:",e)}this.scrollToBottom()}configureMarkdown(){try{if(window.marked){window.marked.setOptions({gfm:!0,breaks:!0,headerIds:!0,mangle:!1,highlight:(e,t)=>window.hljs?t&&window.hljs.getLanguage(t)?window.hljs.highlight(e,{language:t}).value:window.hljs.highlightAuto(e).value:e});const e=new window.marked.Renderer;e.link=(e,t,s)=>`<a href="${e}"${t?` title="${t}"`:""} target="_blank" rel="noopener noreferrer nofollow">${s}</a>`,window.marked.use({renderer:e})}}catch(e){console.warn("Markdown configuration failed:",e)}}normalizeInlineLists(e){try{if(!e||"string"!=typeof e)return e;if(/(^|\n)\s*(?:[-*+]\s+|\d+\.[\t ]+)/.test(e))return e;let t=e;return t=t.replace(/:\s*\*\s+/g,":\n- "),t=t.replace(/\s\*\s+/g,"\n- "),t=t.replace(/\n{3,}/g,"\n\n"),t}catch(t){return e}}formatMessage(e){let t=e;try{if(window.marked){const s=this.normalizeInlineLists(e);t=window.marked.parse(s)}else{const s=/(https?:\/\/[^\s]+)/g;t=this.normalizeInlineLists(e).replace(s,'<a href="$1" target="_blank" rel="noopener noreferrer nofollow">$1</a>')}}catch(s){t=e}try{if(window.DOMPurify)return window.DOMPurify.sanitize(t,{USE_PROFILES:{html:!0},ADD_ATTR:["target","rel","class"],ALLOWED_TAGS:["a","p","br","span","div","strong","em","del","code","pre","blockquote","hr","ul","ol","li","h1","h2","h3","h4","h5","h6","table","thead","tbody","tr","th","td"]})}catch(e){console.warn("Sanitization failed:",e)}return t}showTypingIndicator(){this.elements.typingIndicator.classList.add("active"),this.scrollToBottom()}hideTypingIndicator(){this.elements.typingIndicator.classList.remove("active")}scrollToBottom(){setTimeout((()=>{this.elements.chatMessages.scrollTop=this.elements.chatMessages.scrollHeight}),100)}autoResizeTextarea(){const e=this.elements.messageInput;e.style.height="auto",e.style.height=Math.min(e.scrollHeight,120)+"px"}toggleVoiceInput(){this.voiceEnabled?this.recognition?this.isListening?this.stopVoiceInput():this.startVoiceInput():this.showNotification("Voice input not supported in this browser","error"):this.showNotification("Voice features are disabled","info")}startVoiceInput(){try{this.isListening=!0,this.elements.voiceModal.classList.add("active"),this.elements.voiceToggle.innerHTML='<i class="fas fa-microphone-slash"></i>',this.recognition.start()}catch(e){console.error("Error starting voice input:",e),this.showNotification("Failed to start voice input","error")}}stopVoiceInput(){this.recognition&&this.isListening&&this.recognition.stop(),this.isListening=!1,this.elements.voiceModal.classList.remove("active"),this.elements.voiceToggle.innerHTML='<i class="fas fa-microphone"></i>'}speakMessage(e){if(!this.synthesis)return;this.synthesis.cancel();const t=new SpeechSynthesisUtterance(e);t.rate=.9,t.pitch=1,t.volume=.8;const s=this.synthesis.getVoices().find((e=>e.name.includes("Google")||e.name.includes("Microsoft")||e.name.includes("Natural")));s&&(t.voice=s),this.synthesis.speak(t)}clearChat(){if(confirm("Are you sure you want to clear the chat history?")){this.elements.chatMessages.querySelectorAll(".message:not(:first-child)").forEach((e=>e.remove())),fetch("/api/chat/clear",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({sessionId:this.sessionId})}),this.elements.inputSuggestions.style.display="flex",this.showNotification("Chat history cleared","success")}}showNotification(e,t="info"){const s=document.createElement("div");s.className=`notification notification-${t}`,s.textContent=e,Object.assign(s.style,{position:"fixed",top:"20px",right:"20px",padding:"1rem 1.5rem",borderRadius:"8px",color:"white",fontWeight:"500",zIndex:"10000",transform:"translateX(100%)",transition:"transform 0.3s ease",maxWidth:"300px",wordWrap:"break-word"});const i={success:"#27ae60",error:"#e74c3c",info:"#3498db",warning:"#f39c12"};s.style.backgroundColor=i[t]||i.info,document.body.appendChild(s),setTimeout((()=>{s.style.transform="translateX(0)"}),100),setTimeout((()=>{s.style.transform="translateX(100%)",setTimeout((()=>{s.parentNode&&s.parentNode.removeChild(s)}),300)}),3e3)}}document.addEventListener("DOMContentLoaded",(()=>{new JIAChat}));